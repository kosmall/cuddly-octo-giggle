import{jsx as s,jsxs as k}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as ct,classes as lt}from"@dropins/tools/lib.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/recaptcha.js";import{g as ft,c as dt,a as gt}from"./createCustomerAddress.js";import{useState as b,useEffect as ht,useCallback as G}from"@dropins/tools/preact-hooks.js";import{s as tt,b as Ft,c as pt}from"./simplifyTransformAttributesForm.js";import{v as Ut,u as bt,a as yt}from"./usePasswordValidationMessage.js";import{a as _t}from"./getCustomerToken.js";import{p as et,E as rt}from"./getStoreConfig.js";import{c as H,g as Tt,u as Nt,T as Lt,F as xt,B as it}from"./useInLineAlert.js";import{InLineAlert as Pt,InputPassword as Et,Field as Q,Checkbox as X}from"@dropins/tools/components.js";import{S as St}from"./SkeletonLoader.js";import{E as wt}from"./EmailConfirmationForm.js";import{useText as vt}from"@dropins/tools/i18n.js";const st=(t,e)=>e!=null&&e.length?t.map(a=>{var i;const o=(i=e.find(({code:y})=>y===a.code))==null?void 0:i.defaultValue;return o?{...a,defaultValue:o}:a}):t,Mt=({inputsDefaultValueSet:t,fieldsConfigForApiVersion1:e,apiVersion2:a})=>{const[o,i]=b([]);return ht(()=>{(async()=>{var h;if(a){const r=await ft("customer_account_create");if((h=r==null?void 0:r.fields)!=null&&h.length)if(t!=null&&t.length){const m=st(r==null?void 0:r.fields,t);i(m)}else i(r==null?void 0:r.fields)}else{const r=tt(Ft),m=tt(e),n=st(r,t);i(e&&e.length?m:n)}})()},[a,e,t]),{fieldsListConfigs:o}},At=t=>{switch(t){case"true":case"on":return!0;case"false":case"off":return!1;default:return t}},qt=(t,e)=>{if(!e)return t;const a={};a.custom_attributes=[];for(const o in t)Object.prototype.hasOwnProperty.call(pt,o)?a[o]=t[o]:a.custom_attributes.push({attribute_code:o,value:At(t[o])});return a},Ct=({addressesData:t,translations:e,isEmailConfirmationRequired:a,apiVersion2:o=!0,passwordConfigs:i,isAutoSignInEnabled:y,routeRedirectOnSignIn:h,routeSignIn:r,onErrorCallback:m,onSuccessCallback:n,setActiveComponent:l,handleSetInLineAlertProps:f,routeRedirectOnEmailConfirmationClose:x})=>{const[O,w]=b(""),[F,u]=b(!1),[c,T]=b({userName:"",status:!1}),[v,d]=b(""),[M,A]=b(!1),[V,p]=b(!1),[q,C]=b(!0),P=G(({target:U})=>{C(U.checked)},[]),I=G(()=>{if(H(l)){l("signInForm");return}H(r)&&(window.location.href=r())},[l,r]),W=G(U=>{d(U)},[]),j=G(()=>{f({}),d(""),H(x)?window.location.href=x():(u(!1),l==null||l("signInForm"))},[f,x,l]);return{isKeepMeLogged:q,userEmail:O,showEmailConfirmationForm:F,isSuccessful:c,isClickSubmit:M,signUpPasswordValue:v,isLoading:V,onSubmitSignUp:async(U,$)=>{var Z,z,D;if(f({}),p(!0),!$){A(!0),p(!1);return}const B=o?"createCustomerV2":"createCustomer",_=Tt(U.target),{email:E,password:S,is_subscribed:at}=_,ot=(i==null?void 0:i.requiredCharacterClasses)||0,ut=(i==null?void 0:i.minLength)||1;if(!Ut(S,ot)||ut>(S==null?void 0:S.length)){A(!0),p(!1);return}const nt=qt({..._,is_subscribed:!!at||!1},o),{data:N,errors:L}=await dt(nt,o),K=((z=(Z=N==null?void 0:N.createCustomer)==null?void 0:Z.customer)==null?void 0:z.firstname)||"";if(L&&(L!=null&&L.length))f==null||f({type:"error",text:L[0].message}),m==null||m(L),et(rt.CREATE_ACCOUNT_EVENT,{updateProfile:!1}),w(E);else{const J={email:"",...N==null?void 0:N[B]};if(et(rt.CREATE_ACCOUNT_EVENT,{email:J==null?void 0:J.email,updateProfile:!0}),a||!y){if(n==null||n({userName:K,status:!0}),a){(D=U.target)==null||D.reset(),d(""),u(!0),w(E),p(!1);return}if(!y){p(!1),T({userName:K,status:!0});return}}const g=await _t({email:E,password:S,translations:e,handleSetInLineAlertProps:f,onErrorCallback:m});if(g!=null&&g.userName){if(t!=null&&t.length)for(const R of t)try{await gt(R)}catch(mt){console.error(e.failedCreateCustomerAddress,R,mt)}H(h)?window.location.href=h():(n==null||n({userName:g==null?void 0:g.userName,status:!0}),T({userName:g==null?void 0:g.userName,status:!0}))}else n==null||n({userName:K,status:!0}),T({userName:K,status:!0})}p(!1)},signInButton:I,handleSetSignUpPasswordValue:W,onKeepMeLoggedChange:P,handleHideEmailConfirmationForm:j}},Zt=({addressesData:t,formSize:e="default",inputsDefaultValueSet:a,fieldsConfigForApiVersion1:o,apiVersion2:i=!0,isAutoSignInEnabled:y=!0,displayTermsOfUseCheckbox:h=!1,displayNewsletterCheckbox:r=!1,hideCloseBtnOnEmailConfirmation:m=!1,routeRedirectOnEmailConfirmationClose:n,routeRedirectOnSignIn:l,routeSignIn:f,onErrorCallback:x,onSuccessCallback:O,setActiveComponent:w,slots:F})=>{const u=vt({title:"Auth.SignUpForm.title",buttonPrimary:"Auth.SignUpForm.buttonPrimary",buttonSecondary:"Auth.SignUpForm.buttonSecondary",privacyPolicyDefaultText:"Auth.SignUpForm.privacyPolicyDefaultText",subscribedDefaultText:"Auth.SignUpForm.subscribedDefaultText",keepMeLoggedText:"Auth.SignUpForm.keepMeLoggedText",customerTokenErrorMessage:"Auth.Api.customerTokenErrorMessage",failedCreateCustomerAddress:"Auth.SignUpForm.failedCreateCustomerAddress",placeholder:"Auth.InputPassword.placeholder",floatingLabel:"Auth.InputPassword.floatingLabel"}),{passwordConfigs:c,isEmailConfirmationRequired:T}=bt(),{fieldsListConfigs:v}=Mt({fieldsConfigForApiVersion1:o,apiVersion2:i,inputsDefaultValueSet:a}),{inLineAlertProps:d,handleSetInLineAlertProps:M}=Nt(),{isKeepMeLogged:A,userEmail:V,showEmailConfirmationForm:p,isSuccessful:q,isClickSubmit:C,signUpPasswordValue:P,isLoading:I,onSubmitSignUp:W,signInButton:j,handleSetSignUpPasswordValue:Y,onKeepMeLoggedChange:U,handleHideEmailConfirmationForm:$}=Ct({addressesData:t,translations:u,isEmailConfirmationRequired:T,apiVersion2:i,passwordConfigs:c,isAutoSignInEnabled:y,routeRedirectOnSignIn:l,routeSignIn:f,onErrorCallback:x,onSuccessCallback:O,setActiveComponent:w,handleSetInLineAlertProps:M,routeRedirectOnEmailConfirmationClose:n}),{isValidUniqueSymbols:B,defaultLengthMessage:_}=yt({password:P,isClickSubmit:C,passwordConfigs:c}),E=!T&&(t==null?void 0:t.length);return!v.length&&i?s("div",{className:`auth-signUpForm ${e} skeleton-loader`,"data-testid":"SignUpForm",children:s(St,{activeSkeleton:"signUpForm"})}):q.status&&(F!=null&&F.SuccessNotification)?s(ct,{"data-testid":"successNotificationTestId",name:"SuccessNotification",slot:F==null?void 0:F.SuccessNotification,context:{isSuccessful:q}}):p?s(wt,{formSize:e,userEmail:V,inLineAlertProps:d,hideCloseBtnOnEmailConfirmation:m,handleSetInLineAlertProps:M,onPrimaryButtonClick:$}):k("div",{className:lt(["auth-signUpForm",e]),"data-testid":"SignUpForm",children:[s(Lt,{text:u.title,bottomLine:!1,className:"auth-signUpForm__title"}),d.text?s(Pt,{className:"auth-signUpForm__notification",type:d.type,variant:"secondary",heading:d.text,icon:d.icon}):null,k(xt,{submitCallback:W,className:"auth-signUpForm__form",isLoading:I,name:"signUp_form",fieldsConfig:v,children:[s(Et,{validateLengthConfig:_,className:"auth-signUpForm__form__item",autoComplete:"current-password",name:"password",minLength:c==null?void 0:c.minLength,error:B==="error"||(_==null?void 0:_.status)==="error"||C&&P.length<=0,defaultValue:P,uniqueSymbolsStatus:B,requiredCharacterClasses:c==null?void 0:c.requiredCharacterClasses,onValue:Y,placeholder:u.placeholder,floatingLabel:u.floatingLabel,children:E?s("div",{className:"auth-signUpForm__automatic-login",children:s(Q,{children:s(X,{name:"",placeholder:u.keepMeLoggedText,label:u.keepMeLoggedText,checked:A,onChange:U})})}):null}),r||h?k("div",{className:"auth-signUpForm__item auth-signUpForm__checkbox",children:[r?s(Q,{children:s(X,{"data-testid":"isSubscribed",name:"is_subscribed",placeholder:u.subscribedDefaultText,label:u.subscribedDefaultText})}):null,h?s(Q,{children:s(X,{"data-testid":"privacyPolicy",name:"privacyPolicy",placeholder:u.privacyPolicyDefaultText,label:u.privacyPolicyDefaultText})}):null]}):null,k("div",{className:"auth-signUpForm-buttons",children:[s(it,{type:"button",variant:"tertiary",style:{padding:0},buttonText:u.buttonSecondary,enableLoader:!1,onClick:j}),s(it,{type:"submit",buttonText:u.buttonPrimary,variant:"primary",enableLoader:I})]})]}),s("div",{id:"createCustomerV2"})]})};export{Zt as S};
