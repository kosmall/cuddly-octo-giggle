import{jsxs as T,jsx as n}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as Y,classes as Z}from"@dropins/tools/lib.js";import{g as $,c as w,u as z,T as O,F as R,B as G}from"./useInLineAlert.js";import{useState as g,useCallback as F,useEffect as K,useMemo as tt}from"@dropins/tools/preact-hooks.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/recaptcha.js";import{a as at}from"./getCustomerToken.js";import{r as et}from"./resendConfirmationEmail.js";import{s as rt,a as st}from"./simplifyTransformAttributesForm.js";import{c as ot}from"./confirmEmail.js";import{useText as H}from"@dropins/tools/i18n.js";import{InLineAlert as it,InputPassword as nt}from"@dropins/tools/components.js";import{E as mt}from"./EmailConfirmationForm.js";const ct=({emailConfirmationStatusMessage:t,translations:e,initialEmailValue:o,routeSignUp:c,routeForgotPassword:u,routeRedirectOnSignIn:_,onErrorCallback:b,setActiveComponent:a,onSuccessCallback:l,onSignUpLinkClick:h,handleSetInLineAlertProps:r,routeRedirectOnEmailConfirmationClose:I})=>{const[S,A]=g(""),[f,E]=g(!1),[d,N]=g(""),[M,y]=g(!1),[B,p]=g({userName:"",status:!1}),[k,x]=g(!1),[P,U]=g(!1),C=F(async i=>{await et(i),E(!0),r({})},[r]);K(()=>{P&&(d.length?y(!1):y(!0))},[P,d]),K(()=>{t!=null&&t.text&&r({text:t.text,type:t.status?t.status:void 0})},[t,r]);const L=F(i=>e?T("span",{className:"auth-signInForm__resend-email-notification",children:[e.resendEmailInformationText," ",n("button",{onClick:()=>C(i),children:e.resendEmailButtonText})," ",e.resendEmailAdditionalText]}):"",[C,e]),v=F(async i=>{var q;r({}),x(!0),U(!0);const m=$(i.target);if(m.password||(y(!0),x(!1)),m!=null&&m.email&&(m!=null&&m.password)){const{email:D,password:W}=m,s=await at({email:D,password:W,handleSetInLineAlertProps:r,onErrorCallback:b,translations:e});if((q=s==null?void 0:s.errorMessage)!=null&&q.length){A(D);const X=s.errorMessage.includes("This account isn't confirmed. Verify and try again.")?L(D):s.errorMessage;r({text:X,type:"error"}),N("")}s!=null&&s.userName&&(i.target.reset(),w(_)?window.location.href=_():(l==null||l({userName:s==null?void 0:s.userName,status:!0}),p({userName:s==null?void 0:s.userName,status:!0}))),y(!1)}x(!1)},[L,r,e,b,_,l]),j=F(()=>{if(w(a)){a("resetPasswordForm");return}w(u)&&(window.location.href=u())},[u,a]),J=F(()=>{if(w(h)&&h(),w(a)){a("signUpForm");return}w(c)&&(window.location.href=c())},[h,c,a]),Q=tt(()=>{const i=rt(st);return o!=null&&o.length?i==null?void 0:i.map(m=>({...m,defaultValue:o})):i},[o]),V=F(()=>{r({}),w(I)?window.location.href=I():E(!1)},[r,I]);return{userEmail:S,defaultEnhancedEmailFields:Q,passwordError:M,isSuccessful:B,isLoading:k,signInPasswordValue:d,showEmailConfirmationForm:f,setShowEmailConfirmationForm:E,setSignInPasswordValue:N,submitLogInUser:v,forgotPasswordCallback:j,onSignUpLinkClickCallback:J,handledOnPrimaryButtonClick:V}},ut=()=>{let t=new URL(window.location.href),e=t.searchParams.get("email"),o=t.searchParams.get("key");e&&o&&(t.searchParams.delete("email"),t.searchParams.delete("key"),window.history.replaceState({},document.title,t.toString()))},lt=({enableEmailConfirmation:t})=>{const e=H({accountConfirmMessage:"Auth.EmailConfirmationForm.accountConfirmMessage",accountConfirmationEmailSuccessMessage:"Auth.EmailConfirmationForm.accountConfirmationEmailSuccessMessage"}),[o,c]=g({text:"",status:""});return K(()=>{if(t){const{search:u}=window.location;u.includes("email=")&&u.includes("key=")&&(async()=>{var l,h,r;const b=new URLSearchParams(u),a=await ot({customerEmail:b.get("email"),customerConfirmationKey:b.get("key")});if(!a)return null;(l=a==null?void 0:a.errors)!=null&&l.length?c({text:a==null?void 0:a.errors[0].message,status:"error"}):(c({text:a.data.confirmEmail.customer.email?e.accountConfirmationEmailSuccessMessage.replace("{email}",(r=(h=a==null?void 0:a.data)==null?void 0:h.confirmEmail.customer)==null?void 0:r.email):e.accountConfirmMessage,status:"success"}),ut())})()}},[t,e]),{emailConfirmationStatusMessage:o}},Tt=({slots:t,formSize:e="default",initialEmailValue:o="",renderSignUpLink:c=!1,enableEmailConfirmation:u=!1,hideCloseBtnOnEmailConfirmation:_=!1,routeRedirectOnEmailConfirmationClose:b,routeRedirectOnSignIn:a,routeForgotPassword:l,routeSignUp:h,onSuccessCallback:r,setActiveComponent:I,onErrorCallback:S,onSignUpLinkClick:A})=>{const f=H({title:"Auth.SignInForm.title",buttonPrimary:"Auth.SignInForm.buttonPrimary",buttonSecondary:"Auth.SignInForm.buttonSecondary",buttonTertiary:"Auth.SignInForm.buttonTertiary",resendEmailInformationText:"Auth.Notification.resendEmailNotification.informationText",resendEmailButtonText:"Auth.Notification.resendEmailNotification.buttonText",resendEmailAdditionalText:"Auth.Notification.resendEmailNotification.additionalText",customerTokenErrorMessage:"Auth.Api.customerTokenErrorMessage",placeholder:"Auth.InputPassword.placeholder",floatingLabel:"Auth.InputPassword.floatingLabel"}),{emailConfirmationStatusMessage:E}=lt({enableEmailConfirmation:u}),{inLineAlertProps:d,handleSetInLineAlertProps:N}=z(),{userEmail:M,defaultEnhancedEmailFields:y,passwordError:B,isSuccessful:p,isLoading:k,signInPasswordValue:x,showEmailConfirmationForm:P,setSignInPasswordValue:U,submitLogInUser:C,forgotPasswordCallback:L,onSignUpLinkClickCallback:v,handledOnPrimaryButtonClick:j}=ct({translations:f,emailConfirmationStatusMessage:E,initialEmailValue:o,routeSignUp:h,routeForgotPassword:l,routeRedirectOnSignIn:a,setActiveComponent:I,onErrorCallback:S,onSuccessCallback:r,onSignUpLinkClick:A,handleSetInLineAlertProps:N,routeRedirectOnEmailConfirmationClose:b});return p.status&&(t!=null&&t.SuccessNotification)?n(Y,{"data-testid":"successNotificationTestId",name:"SuccessNotification",slot:t==null?void 0:t.SuccessNotification,context:{isSuccessful:p}}):P?n(mt,{formSize:e,userEmail:M,inLineAlertProps:d,hideCloseBtnOnEmailConfirmation:_,handleSetInLineAlertProps:N,onPrimaryButtonClick:j}):T("div",{className:Z(["auth-signInForm",e]),"data-testid":"signInForm",children:[n(O,{text:f.title,bottomLine:!1,className:"auth-signInForm__title"}),d.text?n(it,{"data-testid":"authInLineAlert",className:"auth-signInForm__notification",type:d.type,variant:"secondary",heading:d.text,icon:d.icon}):null,T(R,{name:"signIn_form",className:"auth-signInForm__form",submitCallback:C,isLoading:k,fieldsConfig:y,children:[n(nt,{hideStatusIndicator:!0,className:"auth-signInForm__form__password",autoComplete:"current-password",error:B,defaultValue:x,onValue:U,placeholder:f.placeholder,floatingLabel:f.floatingLabel}),T("div",{className:"auth-signInForm__form__buttons",children:[T("div",{className:"auth-signInForm__form__buttons--combine",children:[n(G,{type:"button",variant:"tertiary",style:{padding:0},buttonText:f.buttonTertiary,className:"auth-signInForm__button auth-signInForm__button--forgot",enableLoader:!1,onClick:L,"data-testid":"switchToSignUp"}),c?n("span",{}):null,c?n(G,{type:"button",variant:"tertiary",style:{padding:0},buttonText:f.buttonSecondary,className:"auth-signInForm__button auth-signInForm__button--signup",enableLoader:!1,onClick:v}):null]}),n(G,{type:"submit",buttonText:f.buttonPrimary,variant:"primary",className:"auth-signInForm__button auth-signInForm__button--submit",enableLoader:k})]})]}),n("div",{id:"generateCustomerToken"})]})};export{Tt as S};
