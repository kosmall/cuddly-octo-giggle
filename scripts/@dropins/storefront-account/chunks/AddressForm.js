import{jsx as g,jsxs as T,Fragment as O}from"@dropins/tools/preact-jsx-runtime.js";import{classes as U,Slot as $}from"@dropins/tools/lib.js";import{InLineAlert as v,Button as k}from"@dropins/tools/components.js";import"@dropins/tools/event-bus.js";import{a as D,b as K,g as M,u as P,c as W}from"./updateCustomerAddress.js";import{useState as C,useEffect as z,useCallback as N,useMemo as G}from"@dropins/tools/preact-hooks.js";import{d as H,e as Q}from"./addressField.config.js";import{A as S,F as X}from"./OrdersListCard.js";import"@dropins/tools/preact-compat.js";import{useText as Y}from"@dropins/tools/i18n.js";const Z=()=>{const[e,s]=C(""),[n,t]=C({});z(()=>{D().then(a=>{t(u=>({...u,country_code:a}))})},[]),z(()=>{e&&K(e).then(a=>{t(u=>({...u,region:a}))})},[e]);const r=N(a=>{a&&s(a)},[]);return{countryRegionOptions:n,handleSetCountryCode:r}},E=(e,s)=>{const n=s.map(t=>({...t}));return n.forEach(t=>{if(Object.prototype.hasOwnProperty.call(e,t.name)){const r=e[t.name];if(t.name==="region"&&typeof r=="object"){const a=r.region_code&&r.region_id?`${r.region_code},${r.region_id}`:r.region;t.defaultValue=a}else if(Array.isArray(r)){t.defaultValue=r[0];const a=n.find(u=>u.name===`${t.name}_2`);a&&r[1]&&(a.defaultValue=r[1])}else t.defaultValue=r}}),n},q=e=>{if(!e)return null;const s=new FormData(e);if(e.querySelectorAll('input[type="checkbox"]').forEach(t=>{s.has(t.name)||s.set(t.name,"false"),t.checked&&s.set(t.name,"true")}),s&&typeof s.entries=="function"){const t=s.entries();if(t&&typeof t[Symbol.iterator]=="function")return JSON.parse(JSON.stringify(Object.fromEntries(t)))||{}}return{}},ee=e=>{switch(e){case"on":case"true":case 1:case"1":return!0;case"0":case"off":case"false":case 0:return!1;default:return!1}},te=e=>{const s=["region","city","company","country_code","country_id","default_billing","default_shipping","fax","firstname","lastname","middlename","postcode","prefix","street","suffix","telephone","vat_id","addressId"],n={},t=[];return Object.keys(e).forEach(r=>{s.includes(r)?n[r]=e[r]:t.push({attribute_code:r,value:e[r]})}),t.length>0&&(n.custom_attributesV2=t),n},J=e=>{let s=[],n={};for(const c in e){const m=e[c];(m==="on"||m==="off"||m==="true"||m==="false")&&(n[c]=ee(m)),(c==="street"||c==="street_1"||c==="street_2")&&s.push(m)}const{street:t,street_2:r,street_1:a,region:u,...d}=e,[o,l]=u?u.split(","):[void 0,void 0],x=l&&o?{region_id:+l,region_code:o}:{region:o};return te({...d,...n,region:{...x},street:s})},se=(e,s)=>s!=null&&s.length?e.code==="region"?{...e,required:!!(s!=null&&s.length),options:s}:{...e,options:s}:e,re=({addressFormId:e="",billingCheckBoxValue:s,shippingCheckBoxValue:n,showShippingCheckBox:t,showBillingCheckBox:r,countryRegionOptions:a,inputsDefaultValueSet:u,closeForm:d,onSuccess:o,onError:l})=>{const[x,A]=C(!1),[c,m]=C(e),[F,j]=C([]),[_,h]=C({text:"",type:"success"});z(()=>{M(c?"customer_address_edit":"customer_register_address").then(i=>{j(i)})},[c]);const L=N(()=>{h({text:"",type:"success"}),d==null||d()},[d]),b=N(async(i,y)=>{if(!y)return null;A(!0);const B=q(i.target),w=J(B);await P(w).then(()=>{var f;o==null||o(),d==null||d(),(f=i==null?void 0:i.target)==null||f.reset()}).catch(f=>{h(p=>({...p,text:f.message,type:"error"})),l==null||l(f)}).finally(()=>{m(""),A(!1)})},[d,l,o]),I=N(async(i,y)=>{if(!y)return null;A(!0);const B=q(i.target),w=J(B);await W(w).then(()=>{var f;o==null||o(),d==null||d(),(f=i==null?void 0:i.target)==null||f.reset()}).catch(f=>{h(p=>({...p,text:f.message,type:"error"})),l==null||l(f)}).finally(()=>{m(""),A(!1)})},[d,l,o]),V=G(()=>{if(!F.length)return[];const i={...H,defaultValue:n,is_hidden:!t},y={...Q,defaultValue:s,is_hidden:!r},B=[...F,i,y];return E(u||{},B).filter(p=>!(c&&(p.code==="default_shipping"||p.code==="default_billing")&&p.defaultValue)).map(p=>{const R=a[p.code];return se(p,R)})},[F,t,n,r,s,u,a,c]);return{inLineAlert:_,addressId:c,submitLoading:x,normalizeFieldsConfig:V,handleUpdateAddress:b,handleCreateAddress:I,handleOnCloseForm:L}},pe=({slots:e,addressesFormTitle:s,className:n,addressFormId:t,inputsDefaultValueSet:r,shippingCheckBoxValue:a,billingCheckBoxValue:u,showShippingCheckBox:d,showBillingCheckBox:o,isOpen:l,onSubmit:x,closeForm:A,onSuccess:c,onError:m})=>{const{countryRegionOptions:F,handleSetCountryCode:j}=Z(),{inLineAlert:_,addressId:h,submitLoading:L,normalizeFieldsConfig:b,handleUpdateAddress:I,handleCreateAddress:V,handleOnCloseForm:i}=re({addressFormId:t,inputsDefaultValueSet:r,countryRegionOptions:F,shippingCheckBoxValue:a,billingCheckBoxValue:u,showShippingCheckBox:d,showBillingCheckBox:o,onSuccess:c,onError:m,closeForm:A}),y=Y({secondaryButton:"Account.AddressForm.formText.secondaryButton",primaryButton:"Account.AddressForm.formText.primaryButton"});return l?b!=null&&b.length?T("div",{className:U(["dropin-address-form__wrapper",n]),children:[g("div",{className:"dropin-address-form__wrapper--title","data-testid":"addressesFormTitle",children:s}),_.text?g(v,{"data-testid":"inLineAlert",className:"dropin-address-form__wrapper--notification",type:_.type,variant:"secondary",heading:_.text,icon:_.icon}):null,T(X,{className:"dropin-address-form",name:"addressesForm",loading:L,fieldsConfig:b,onSubmit:x||(h?I:V),handleSetCountryCode:j,children:[h?g("input",{type:"hidden",name:"addressId",value:h,"data-testid":"hidden_test_id"}):null,e!=null&&e.AddressFormInputs?g($,{"data-testid":"addressFormInputs",name:"AddressFormInputs",slot:e.AddressFormInputs}):null,g("div",{className:"dropin-field dropin-address-form__wrapper--buttons",children:e!=null&&e.AddressFormActions?g($,{"data-testid":"addressFormActions",name:"AddressFormActions",slot:e.AddressFormActions,context:{handleUpdateAddress:I,handleCreateAddress:V,addressId:h}}):T(O,{children:[g(k,{type:"button",onClick:i,variant:"secondary",disabled:L,children:y.secondaryButton}),g(k,{disabled:L,children:y.primaryButton})]})})]})]}):g(S,{}):null};export{pe as A};
