import{jsx as n,Fragment as S,jsxs as E}from"@dropins/tools/preact-jsx-runtime.js";import{classes as v,Slot as W}from"@dropins/tools/lib.js";import{Field as D,Picker as K,Input as X,InputDate as G,Checkbox as H,Card as Q,Skeleton as U,SkeletonRow as A,InLineAlert as Y,Button as R}from"@dropins/tools/components.js";import{useRef as Z,useState as V,useEffect as N,useCallback as I,useMemo as ee}from"@dropins/tools/preact-hooks.js";import{F as q,i as te,j as re,d as ae,u as se,e as de,k as ne,l as ie}from"./updateCustomerAddress.js";import{useText as J}from"@dropins/tools/i18n.js";import{memo as P,useCallback as B}from"@dropins/tools/preact-compat.js";const le=t=>t.reduce((r,{code:l,required:s,defaultValue:a})=>(s&&(r[l]=a),r),{}),oe=({fieldsConfig:t,onSubmit:r,handleSetCountryCode:l})=>{const{requiredFieldError:s}=J({requiredFieldError:"Account.FormText.requiredFieldError"}),a=Z(null),[i,u]=V({}),[d,y]=V({}),[f,F]=V({previousCountryCode:null,previousRegionCode:null,initialLoad:!0});N(()=>{var b;const p=i.country_code,o=t==null?void 0:t.find(m=>m.code==="region");if(f.initialLoad)F(m=>({...m,previousCountryCode:p,initialLoad:!1}));else if(f.previousCountryCode!==p){F(h=>({...h,previousCountryCode:p}));const m=!((b=o==null?void 0:o.options)!=null&&b.length)&&!(o!=null&&o.defaultValue)||f.previousRegionCode?"":(o==null?void 0:o.defaultValue)??"";u(h=>({...h,region:m})),l(p)}o!=null&&o.defaultValue&&f.previousCountryCode===p&&F(m=>({...m,previousRegionCode:o.defaultValue}))},[t,i,f.previousCountryCode,f.initialLoad,f.previousRegionCode,l,u]),N(()=>{if(!(t!=null&&t.length))return;const p=le(t);u(p)},[t==null?void 0:t.length]);const _=I((p,o)=>{const b=t.find(h=>h.code===p);return b!=null&&b.required&&!o?s:""},[t,s]),e=I(p=>{const{name:o,value:b,type:m,checked:h}=p==null?void 0:p.target,C=m==="checkbox"?h:b;u(x=>({...x,[o]:C}))},[]),c=I(p=>{const{name:o,value:b,type:m,checked:h}=p==null?void 0:p.target,C=m==="checkbox"?h:b;y(x=>({...x,[o]:_(o,C)}))},[_]),g=I(p=>{p.preventDefault();let o=!0,b={},m=null;for(const[h,C]of Object.entries(i)){const x=_(h,C);x&&(b[h]=x,o=!1,m||(m=h))}if(y(b),m&&a.current){const h=a.current.elements.namedItem(m);h==null||h.focus()}r==null||r(p,o)},[i,_,r]);return{formData:i,errors:d,formRef:a,handleChange:e,handleBlur:c,handleSubmit:g}},ue=P(({loading:t,values:r,fields:l=[],errors:s,className:a="",onChange:i,onBlur:u})=>{const d=`${a}__field`,y=B((e,c,g)=>n(D,{error:g,className:v([d,`${d}--${e.id}`,[`${d}--${e.id}-hidden`,e.is_hidden],e.className]),"data-testid":`${a}--${e.id}`,disabled:t,children:n(K,{name:e.id,floatingLabel:`${e.label} ${e.required?"*":""}`,placeholder:e.label,"aria-label":e.label,options:e.options,onBlur:u,handleSelect:i,value:c||e.defaultValue})},e.id),[a,t,d,u,i]),f=B((e,c,g)=>n(D,{error:g,className:v([d,`${d}--${e.id}`,[`${d}--${e.id}-hidden`,e.is_hidden],e.className]),"data-testid":`${a}--${e.id}`,disabled:t,children:n(X,{type:"text",name:e.id,value:c===void 0?e.defaultValue:c,placeholder:e.label,floatingLabel:`${e.label} ${e.required?"*":""}`,onBlur:u,onChange:i})},e.id),[a,t,d,u,i]),F=B((e,c,g)=>n(D,{error:g,className:v([d,`${d}--${e.id}`,[`${d}--${e.id}-hidden`,e.is_hidden],e.className]),"data-testid":`${a}--${e.id}`,disabled:t,children:n(G,{type:"text",name:e.id,value:c||e.defaultValue,placeholder:e.label,floatingLabel:`${e.label} ${e.required?"*":""}`,onBlur:u,onChange:i})},e.id),[a,t,d,u,i]),_=B((e,c,g)=>n(D,{error:g,className:v([d,`${d}--${e.id}`,[`${d}--${e.id}-hidden`,e.is_hidden],e.className]),"data-testid":`${a}--${e.id}`,disabled:t,children:n(H,{name:e.id,checked:c||e.defaultValue,placeholder:e.label,label:`${e.label} ${e.required?"*":""}`,onBlur:u,onChange:i})},e.id),[a,t,d,u,i]);return l.length?n(S,{children:l.map(e=>{const c=(s==null?void 0:s[e.id])??void 0,g=(r==null?void 0:r[e.id])??void 0;switch(e.fieldType){case q.TEXT:return e.options.length?y(e,g,c):f(e,g,c);case q.MULTILINE:return f(e,g,c);case q.SELECT:return y(e,g,c);case q.DATE:return F(e,g,c);case q.BOOLEAN:return _(e,g,c);default:return null}})}):null}),ce=P(({name:t,loading:r,children:l,className:s="defaultForm",fieldsConfig:a,onSubmit:i,handleSetCountryCode:u})=>{const{formData:d,errors:y,formRef:f,handleChange:F,handleBlur:_,handleSubmit:e}=oe({fieldsConfig:a,onSubmit:i,handleSetCountryCode:u});return E("form",{className:v(["dropin-form",s]),onSubmit:e,name:t,ref:f,children:[n(ue,{className:s,loading:r,fields:a,onChange:F,onBlur:_,errors:y,values:d}),l]})}),ze=({testId:t,withCard:r=!0})=>{const l=E(U,{"data-testid":t||"skeletonLoader",children:[n(A,{variant:"heading",size:"xlarge",fullWidth:!1,lines:1}),n(A,{variant:"heading",size:"xlarge",fullWidth:!0,lines:1}),n(A,{variant:"heading",size:"xlarge",fullWidth:!0,lines:1})]});return r?l:n(Q,{variant:"secondary",className:v(["dropin-account-loaders","dropin-account-loaders--card-loader"]),children:l})},fe=()=>E(U,{"data-testid":"addressFormLoader",children:[n(A,{variant:"heading",size:"medium"}),n(A,{variant:"empty",size:"medium"}),n(A,{size:"large"}),n(A,{size:"large"}),n(A,{size:"large",fullWidth:!0}),n(A,{size:"large",fullWidth:!0,lines:3}),n(A,{size:"large"}),n(A,{size:"large"}),n(A,{size:"large"}),n(A,{size:"large"}),n(A,{size:"large"}),n(A,{size:"large"}),n(A,{size:"large",fullWidth:!0})]}),pe=()=>{const[t,r]=V(""),[l,s]=V({});N(()=>{te().then(i=>{s(u=>({...u,country_code:i}))})},[]),N(()=>{t&&re(t).then(i=>{s(u=>({...u,region:i}))})},[t]);const a=I(i=>{i&&r(i)},[]);return{countryRegionOptions:l,handleSetCountryCode:a}},he=(t,r)=>{const l=r.map(s=>({...s}));return l.forEach(s=>{if(Object.prototype.hasOwnProperty.call(t,s.name)){const a=t[s.name];if(s.name==="region"&&typeof a=="object"){const i=a.region_code&&a.region_id?`${a.region_code},${a.region_id}`:a.region;s.defaultValue=i}else if(Array.isArray(a)){s.defaultValue=a[0];const i=l.find(u=>u.name===`${s.name}_2`);i&&a[1]&&(i.defaultValue=a[1])}else s.defaultValue=a}}),l},M=t=>{if(!t)return null;const r=new FormData(t);if(t.querySelectorAll('input[type="checkbox"]').forEach(s=>{r.has(s.name)||r.set(s.name,"false"),s.checked&&r.set(s.name,"true")}),r&&typeof r.entries=="function"){const s=r.entries();if(s&&typeof s[Symbol.iterator]=="function")return JSON.parse(JSON.stringify(Object.fromEntries(s)))||{}}return{}},me=t=>{switch(t){case"on":case"true":case 1:case"1":return!0;case"0":case"off":case"false":case 0:return!1;default:return!1}},ye=t=>{const r=["region","city","company","country_code","country_id","default_billing","default_shipping","fax","firstname","lastname","middlename","postcode","prefix","street","suffix","telephone","vat_id","addressId"],l={},s=[];return Object.keys(t).forEach(a=>{r.includes(a)?l[a]=t[a]:s.push({attribute_code:a,value:t[a]})}),s.length>0&&(l.custom_attributesV2=s),l},O=t=>{let r=[],l={};for(const e in t){const c=t[e];(c==="on"||c==="off"||c==="true"||c==="false")&&(l[e]=me(c)),(e==="street"||e==="street_1"||e==="street_2")&&r.push(c)}const{street:s,street_2:a,street_1:i,region:u,...d}=t,[y,f]=u?u.split(","):[void 0,void 0],F=f&&y?{region_id:+f,region_code:y}:{region:y};return ye({...d,...l,region:{...F},street:r})},ge=(t,r)=>r!=null&&r.length?t.code==="region"?{...t,required:!!(r!=null&&r.length),options:r}:{...t,options:r}:t,be=({addressFormId:t="",billingCheckBoxValue:r,shippingCheckBoxValue:l,showShippingCheckBox:s,showBillingCheckBox:a,countryRegionOptions:i,inputsDefaultValueSet:u,closeForm:d,onSuccess:y,onError:f})=>{const[F,_]=V(!1),[e,c]=V(t),[g,p]=V([]),[o,b]=V({text:"",type:"success"});N(()=>{ae(e?"customer_address_edit":"customer_register_address").then($=>{p($)})},[e]);const m=I(()=>{b({text:"",type:"success"}),d==null||d()},[d]),h=I(async($,k)=>{if(!k)return null;_(!0);const T=M($.target),w=O(T);await se(w).then(()=>{var L;y==null||y(),d==null||d(),(L=$==null?void 0:$.target)==null||L.reset()}).catch(L=>{b(z=>({...z,text:L.message,type:"error"})),f==null||f(L)}).finally(()=>{c(""),_(!1)})},[d,f,y]),C=I(async($,k)=>{if(!k)return null;_(!0);const T=M($.target),w=O(T);await de(w).then(()=>{var L;y==null||y(),d==null||d(),(L=$==null?void 0:$.target)==null||L.reset()}).catch(L=>{b(z=>({...z,text:L.message,type:"error"})),f==null||f(L)}).finally(()=>{c(""),_(!1)})},[d,f,y]),x=ee(()=>{if(!g.length)return[];const $={...ne,defaultValue:l,is_hidden:!s},k={...ie,defaultValue:r,is_hidden:!a},T=[...g,$,k];return he(u||{},T).filter(z=>!(e&&(z.code==="default_shipping"||z.code==="default_billing")&&z.defaultValue)).map(z=>{const j=i[z.code];return ge(z,j)})},[g,s,l,a,r,u,i,e]);return{inLineAlert:o,addressId:e,submitLoading:F,normalizeFieldsConfig:x,handleUpdateAddress:h,handleCreateAddress:C,handleOnCloseForm:m}},Ve=({slots:t,addressesFormTitle:r,className:l,addressFormId:s,inputsDefaultValueSet:a,shippingCheckBoxValue:i,billingCheckBoxValue:u,showShippingCheckBox:d,showBillingCheckBox:y,isOpen:f,onSubmit:F,closeForm:_,onSuccess:e,onError:c})=>{const{countryRegionOptions:g,handleSetCountryCode:p}=pe(),{inLineAlert:o,addressId:b,submitLoading:m,normalizeFieldsConfig:h,handleUpdateAddress:C,handleCreateAddress:x,handleOnCloseForm:$}=be({addressFormId:s,inputsDefaultValueSet:a,countryRegionOptions:g,shippingCheckBoxValue:i,billingCheckBoxValue:u,showShippingCheckBox:d,showBillingCheckBox:y,onSuccess:e,onError:c,closeForm:_}),k=J({secondaryButton:"Account.AddressForm.formText.secondaryButton",primaryButton:"Account.AddressForm.formText.primaryButton"});return f?h!=null&&h.length?E("div",{className:v(["dropin-address-form__wrapper",l]),children:[n("div",{className:"dropin-address-form__wrapper--title","data-testid":"addressesFormTitle",children:r}),o.text?n(Y,{"data-testid":"inLineAlert",className:"dropin-address-form__wrapper--notification",type:o.type,variant:"secondary",heading:o.text,icon:o.icon}):null,E(ce,{className:"dropin-address-form",name:"addressesForm",loading:m,fieldsConfig:h,onSubmit:F||(b?C:x),handleSetCountryCode:p,children:[b?n("input",{type:"hidden",name:"addressId",value:b,"data-testid":"hidden_test_id"}):null,t!=null&&t.AddressFormInputs?n(W,{"data-testid":"addressFormInputs",name:"AddressFormInputs",slot:t.AddressFormInputs}):null,n("div",{className:"dropin-field dropin-address-form__wrapper--buttons",children:t!=null&&t.AddressFormActions?n(W,{"data-testid":"addressFormActions",name:"AddressFormActions",slot:t.AddressFormActions,context:{handleUpdateAddress:C,handleCreateAddress:x,addressId:b}}):E(S,{children:[n(R,{type:"button",onClick:$,variant:"secondary",disabled:m,children:k.secondaryButton}),n(R,{disabled:m,children:k.primaryButton})]})})]})]}):n(fe,{}):null};export{Ve as A,ze as C};
